<!DOCTYPE html>
<html lang="ko" layout:decorate="~{layout/layout}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf.layout">

<head>
    <meta charset="UTF-8">
    <title th:text="${project.name} + ' - Deployment Management'">Deployment Management</title>

    <!-- CSRF 토큰 -->
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />

    <!-- 응답 UI 스타일 -->
    <style>
        .llm-response {
            white-space: pre-wrap;     /* 줄바꿈과 연속 공백 보존 */
            word-break: break-word;    /* 긴 단어 줄바꿈 */
            background-color: #fdfdfd;
            padding: 16px 18px;
            border-radius: 10px;
            font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
            font-size: 15px;
            line-height: 1.7;
            color: #2c2c2c;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
            border: 1px solid #e8e8e8;
        }
    </style>
</head>
<body>

<section layout:fragment="page-content">
    <div class="container-fluid p-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mt-4">서비스 배포 관리</h1>
                <p>배포 명세 생성을 요청하세요.</p>
            </div>
            <a th:href="@{/projects/{id}/deploy/download-config(id=${project.id})}" class="btn btn-info">
                Log Deployer 다운로드
            </a>
        </div>

        <!-- 채팅창 -->
        <div id="chat-window" class="border rounded p-3 mb-3" style="height: 500px; overflow-y: auto;">
            <!-- 기존 채팅 이력 -->
            <div th:each="msg : ${chatHistory}">
                <div th:if="${msg.userQuery}" class="d-flex justify-content-end mb-2">
                    <div class="card bg-primary text-white p-2" style="max-width:70%;">
                        <p class="mb-0" th:text="${msg.userQuery}"></p>
                    </div>
                </div>
                <div th:if="${msg.llmResponse}" class="d-flex justify-content-start mb-2">
                    <div class="card bg-light p-2" style="max-width:70%;">
                        <h6 class="card-title">응답</h6>
                        <pre class="llm-response" th:text="${msg.llmResponse}"></pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- 채팅 입력 -->
        <form id="chat-form">
            <div class="input-group">
                <input type="text" id="query" name="query" class="form-control"
                       placeholder="예: '레디스 3개 복제 배포 생성'" required>
                <button class="btn btn-primary" type="submit">Send</button>
            </div>
        </form>

        <th:block layout:fragment="page-scripts">
            <script>
                let projectId = /*[[${project.id}]]*/ 0;
                if (!projectId || projectId === 0) {
                    const match = window.location.pathname.match(/\/projects\/(\d+)\/chat/);
                    if (match) {
                        projectId = parseInt(match[1], 10);
                    }
                }

                let eventSource = null;

                document.getElementById("chat-form").addEventListener("submit", function (e) {
                    e.preventDefault();

                    const queryInput = document.getElementById("query");
                    const prompt = queryInput.value.trim();
                    if (!prompt) return;

                    const chatWindow = document.getElementById("chat-window");

                    // 기존 SSE 닫기
                    if (eventSource) {
                        eventSource.close();
                        eventSource = null;
                    }

                    // 사용자 메시지 표시
                    chatWindow.innerHTML += `
                        <div class="d-flex justify-content-end mb-2">
                            <div class="card bg-primary text-white p-2" style="max-width:70%;">
                                <p class="mb-0">${prompt}</p>
                            </div>
                        </div>
                    `;

                    // 응답 카드 준비
                    const wrapper = document.createElement("div");
                    wrapper.classList.add("d-flex", "justify-content-start", "mb-2");
                    wrapper.innerHTML = `
                        <div class="card bg-light p-2" style="max-width:70%;">
                            <h6 class="card-title">응답</h6>
                            <pre class="llm-response"></pre>
                        </div>
                    `;
                    chatWindow.appendChild(wrapper);

                    // 여기서 새로 만든 pre 엘리먼트를 잡아둠
                    const explanationElem = wrapper.querySelector(".llm-response");

                    // SSE 요청 (토큰 단위 수신)
                    const url = `/projects/${projectId}/chat/stream?query=${encodeURIComponent(prompt)}`;
                    eventSource = new EventSource(url);

                    eventSource.onmessage = function (event) {
                        const token = event.data
                            .replace(/ /g, '&nbsp;') // 공백 보존
                            .replace(/\n/g, '<br>'); // 줄바꿈 보존
                        explanationElem.innerHTML += token; // 이번 요청의 박스에만 출력
                        chatWindow.scrollTop = chatWindow.scrollHeight;
                    };

                    eventSource.onerror = function () {
                        eventSource.close();
                        eventSource = null;
                    };
                });
            </script>
        </th:block>
    </div>
</section>
</body>
</html>