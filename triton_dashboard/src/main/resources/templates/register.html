<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Register</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- 아이콘 (눈 모양 등) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <style>
    .api-key-input { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Courier New", monospace; }
    .provider-card { border: 1px solid #ececec; border-radius: 12px; padding: 16px; }
    .provider-header { display:flex; align-items:center; gap:8px; margin-bottom:8px; }
    .status-badge { min-width: 92px; text-align:center; }
  </style>
</head>
<body>
<div class="container">
  <div class="row justify-content-center mt-5">
    <div class="col-md-7 col-lg-6">
      <div class="card-body">
        <h3 class="card-title text-center mb-4">Triton 계정 생성</h3>

        <form th:action="@{/register}" th:object="${user}" method="post" id="regForm" autocomplete="off">
          <!-- 기본 정보 -->
          <div class="mb-3">
            <label class="form-label">Username</label>
            <input type="text" class="form-control" th:field="*{username}" required autocomplete="username">
          </div>
          <div class="mb-3">
            <label class="form-label">Password</label>
            <input type="password" class="form-control" th:field="*{password}" required autocomplete="new-password">
          </div>

          <!-- API 키 검증 에러 -->
          <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>

          <h5 class="mt-4 mb-2">LLM API 키 (선택 입력 · 비어있으면 스킵)</h5>
          <p class="text-muted small mb-3">회원가입 버튼 클릭 시, 일괄 검증합니다.</p>

          <!-- OpenAI -->
          <div class="provider-card mb-3">
            <div class="provider-header">
              <img alt="" width="20" height="20" src="https://fav.farm/🟦" />
              <strong class="me-2">OpenAI</strong>
              <span class="badge status-badge"
                    th:classappend="${validation != null and validation.results['OPENAI'] == 'valid'} ? ' text-bg-success'
                                   : (${validation != null and validation.results['OPENAI'] == 'skipped'} ? ' text-bg-secondary'
                                   : (${validation != null and validation.results['OPENAI'] != null} ? ' text-bg-danger' : ' text-bg-light') )"
                    th:text="${validation != null and validation.results['OPENAI'] != null ? validation.results['OPENAI'] : '상태 미확인'}">
              </span>
            </div>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-key"></i></span>
              <input type="password" class="form-control api-key-input"
                     th:classappend="${validation != null and validation.results['OPENAI'] != null and validation.results['OPENAI'].startsWith('error')} ? ' is-invalid' : ''"
                     th:field="*{openaiApiKey}" placeholder="발급받은 API Key" inputmode="latin" autocapitalize="off" spellcheck="false">
              <button class="btn btn-outline-secondary toggle-visibility" type="button"><i class="bi bi-eye"></i></button>
            </div>
            <div class="invalid-feedback"
                 th:if="${validation != null and validation.results['OPENAI'] != null and validation.results['OPENAI'].startsWith('error')}"
                 th:text="${validation.results['OPENAI']}">잘못된 키</div>
          </div>

          <!-- Anthropic -->
          <div class="provider-card mb-3">
            <div class="provider-header">
              <img alt="" width="20" height="20" src="https://fav.farm/🟪" />
              <strong class="me-2">Anthropic</strong>
              <span class="badge status-badge"
                    th:classappend="${validation != null and validation.results['ANTHROPIC'] == 'valid'} ? ' text-bg-success'
                                   : (${validation != null and validation.results['ANTHROPIC'] == 'skipped'} ? ' text-bg-secondary'
                                   : (${validation != null and validation.results['ANTHROPIC'] != null} ? ' text-bg-danger' : ' text-bg-light') )"
                    th:text="${validation != null and validation.results['ANTHROPIC'] != null ? validation.results['ANTHROPIC'] : '상태 미확인'}">
              </span>
            </div>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-key"></i></span>
              <input type="password" class="form-control api-key-input"
                     th:classappend="${validation != null and validation.results['ANTHROPIC'] != null and validation.results['ANTHROPIC'].startsWith('error')} ? ' is-invalid' : ''"
                     th:field="*{anthropicApiKey}" placeholder="발급받은 API Key" inputmode="latin" autocapitalize="off" spellcheck="false">
              <button class="btn btn-outline-secondary toggle-visibility" type="button"><i class="bi bi-eye"></i></button>
            </div>
            <div class="invalid-feedback"
                 th:if="${validation != null and validation.results['ANTHROPIC'] != null and validation.results['ANTHROPIC'].startsWith('error')}"
                 th:text="${validation.results['ANTHROPIC']}">잘못된 키</div>
          </div>

          <!-- Google -->
          <div class="provider-card mb-3">
            <div class="provider-header">
              <img alt="" width="20" height="20" src="https://fav.farm/🟩" />
              <strong class="me-2">Google (Gemini)</strong>
              <span class="badge status-badge"
                    th:classappend="${validation != null and validation.results['GOOGLE'] == 'valid'} ? ' text-bg-success'
                                   : (${validation != null and validation.results['GOOGLE'] == 'skipped'} ? ' text-bg-secondary'
                                   : (${validation != null and validation.results['GOOGLE'] != null} ? ' text-bg-danger' : ' text-bg-light') )"
                    th:text="${validation != null and validation.results['GOOGLE'] != null ? validation.results['GOOGLE'] : '상태 미확인'}">
              </span>
            </div>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-key"></i></span>
              <input type="password" class="form-control api-key-input"
                     th:classappend="${validation != null and validation.results['GOOGLE'] != null and validation.results['GOOGLE'].startsWith('error')} ? ' is-invalid' : ''"
                     th:field="*{googleApiKey}" placeholder="발급받은 API Key" inputmode="latin" autocapitalize="off" spellcheck="false">
              <button class="btn btn-outline-secondary toggle-visibility" type="button"><i class="bi bi-eye"></i></button>
            </div>
            <div class="invalid-feedback"
                 th:if="${validation != null and validation.results['GOOGLE'] != null and validation.results['GOOGLE'].startsWith('error')}"
                 th:text="${validation.results['GOOGLE']}">잘못된 키</div>
          </div>

          <!-- Grok -->
          <div class="provider-card mb-3">
            <div class="provider-header">
              <img alt="" width="20" height="20" src="https://fav.farm/⬛️" />
              <strong class="me-2">Grok</strong>
              <span class="badge status-badge"
                    th:classappend="${validation != null and validation.results['GROK'] == 'valid'} ? ' text-bg-success'
                                   : (${validation != null and validation.results['GROK'] == 'skipped'} ? ' text-bg-secondary'
                                   : (${validation != null and validation.results['GROK'] != null} ? ' text-bg-danger' : ' text-bg-light') )"
                    th:text="${validation != null and validation.results['GROK'] != null ? validation.results['GROK'] : '상태 미확인'}">
              </span>
            </div>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-key"></i></span>
              <input type="password" class="form-control api-key-input"
                     th:classappend="${validation != null and validation.results['GROK'] != null and validation.results['GROK'].startsWith('error')} ? ' is-invalid' : ''"
                     th:field="*{grokApiKey}" placeholder="발급받은 API Key" inputmode="latin" autocapitalize="off" spellcheck="false">
              <button class="btn btn-outline-secondary toggle-visibility" type="button"><i class="bi bi-eye"></i></button>
            </div>
            <div class="invalid-feedback"
                 th:if="${validation != null and validation.results['GROK'] != null and validation.results['GROK'].startsWith('error')}"
                 th:text="${validation.results['GROK']}">잘못된 키</div>
          </div>

          <!-- 회원가입 버튼 -->
          <button type="submit" class="btn btn-primary w-100">Register</button>

          <div class="text-center mt-3">
            <a th:href="@{/login}">이미 계정이 있으신가요? 로그인</a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  // 가리기/보이기 토글
  document.querySelectorAll('.toggle-visibility').forEach(btn => {
    btn.addEventListener('click', () => {
      const input = btn.parentElement.querySelector('input');
      const icon = btn.querySelector('i');
      const isPwd = input.type === 'password';
      input.type = isPwd ? 'text' : 'password';
      icon.classList.toggle('bi-eye');
      icon.classList.toggle('bi-eye-slash');
    });
  });

  // 붙여넣기/입력 시 공백, 줄바꿈, 따옴표 정리
  document.querySelectorAll('.api-key-input').forEach(inp => {
    inp.addEventListener('paste', e => {
      e.preventDefault();
      const text = (e.clipboardData || window.clipboardData).getData('text');
      inp.value = text.replace(/\s+/g, '').replace(/^['"]|['"]$/g, '');
      inp.dispatchEvent(new Event('input'));
    });
    inp.addEventListener('blur', () => {
      inp.value = inp.value.replace(/\s+/g, '').replace(/^['"]|['"]$/g, '');
    });
  });
</script>
</body>
</html>
